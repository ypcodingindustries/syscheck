#!/bin/bash
# CONFIG
BIRTHDAY="2026-02-04"
AG_IP="100.96.42.118"
DAILY_QUOTA=25 # GB

# COLORS
B='\033[1;34m' 
Y='\033[1;33m'
R='\033[0;31m'
NC='\033[0m'

# VERIFIED BAR FUNCTION
get_bar() {
    local perc=$1
    local is_min_needed=$2
    local fill=$(( perc / 5 ))
    if [[ "$is_min_needed" == "true" && "$fill" -eq 0 && "$perc" -gt 0 ]]; then
        fill=1
    fi
    (( fill > 20 )) && fill=20
    local COLOR=$B
    [[ "$perc" -ge 70 ]] && COLOR=$Y
    [[ "$perc" -ge 90 ]] && COLOR=$R
    local bar=""
    for ((i=0; i<fill; i++)); do bar+="█"; done
    local empty=$(( 20 - fill ))
    for ((i=0; i<empty; i++)); do bar+=" "; done
    echo -e "${COLOR}${bar}${NC}"
}

# STATS
RAM_T=$(free -m | awk '/Mem:/ { print $2 }')
RAM_U=$(free -m | awk '/Mem:/ { print $3 }')
RAM_P=$(( RAM_U * 100 / RAM_T ))
CPU_V=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}' | cut -d. -f1)
DISK_P=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
DAYS=$(( ($(date +%s) - $(date -d "$BIRTHDAY" +%s)) / 86400 ))
LIFE_P=$(( DAYS * 100 / 365 ))
[[ "$DAYS" -gt 0 && "$LIFE_P" -eq 0 ]] && LIFE_P=1

# BANDWIDTH
BW_DATA=$(vnstat -i ens3 -d --oneline | cut -d';' -f4)
BW_VAL=$(echo $BW_DATA | awk '{print $1}')
BW_UNIT=$(echo $BW_DATA | awk '{print $2}')
if [[ "$BW_UNIT" == "MiB" ]]; then BW_PERC=1; elif [[ "$BW_UNIT" == "TiB" ]]; then BW_PERC=100; else
    BW_PERC=$(echo "$BW_VAL $DAILY_QUOTA" | awk '{printf "%d", ($1*100)/$2}')
    [[ $(echo "$BW_VAL > 0" | bc -l) -eq 1 && "$BW_PERC" -eq 0 ]] && BW_PERC=1
fi

# SECURITY
LOG="/var/log/fail2ban.log"
TOTAL_DEF=$(grep -c "Ban " $LOG 2>/dev/null || echo "0")
RECIDIVE=$(grep "recidive" $LOG 2>/dev/null | grep -c "Ban " || echo "0")
FAILED_SSH=$(journalctl _COMM=sshd --since "24 hours ago" 2>/dev/null | grep -c "Failed password")
TS_IP=$(tailscale ip -4 2>/dev/null || echo "127.0.0.1")

# PRE-CALC BARS
R_BAR=$(get_bar $RAM_P "false")
C_BAR=$(get_bar $CPU_V "false")
D_BAR=$(get_bar $DISK_P "false")
L_BAR=$(get_bar $LIFE_P "true")
BW_BAR=$(get_bar $BW_PERC "true")

# HEALTH LOGIC (The fix for your missing bar)
if [ -f /var/run/reboot-required ]; then
    H_S="${R}REBOOT NEEDED${NC}"
    H_B="${R}████████████████████${NC}"
else
    H_S="${B}Healthy${NC}"
    H_B="${B}████████████████████${NC}"
fi

# ADGUARD LOGIC
AG_DATA=$(curl -s --max-time 1 -u "${AG_USER}:${AG_PASS}" "http://${AG_IP}:8080/control/stats")
TOTAL_Q=$(echo "$AG_DATA" | grep -o '"num_dns_queries":[0-9]*' | cut -d: -f2)
BLOCKED=$(echo "$AG_DATA" | grep -o '"num_blocked_filtering":[0-9]*' | cut -d: -f2)
if [[ -z "$BLOCKED" ]]; then AG_D="${R}Offline${NC}"; AG_SQ="${R}█${NC}"; else
    AG_PERC=0; [[ "$TOTAL_Q" -gt 0 ]] && AG_PERC=$(( 100 * BLOCKED / TOTAL_Q ))
    AG_D="${BLOCKED} blocks (${B}${AG_PERC}%${NC})"; AG_SQ="${B}█${NC}"
fi

# SERVICE CHECKS
C_SQ=$([[ $(curl -s --max-time 1 -o /dev/null -w "%{http_code}" http://localhost:2019/metrics) == "200" ]] && echo -e "${B}█${NC}" || echo -e "${R}█${NC}")
H_SQ=$([[ $(curl -s --max-time 1 -o /dev/null -w "%{http_code}" http://127.0.0.1:3000/) =~ (200|302) ]] && echo -e "${B}█${NC}" || echo -e "${R}█${NC}")

# DISPLAY
fastfetch
echo "----------------------------------------------------------------------------------"
echo -e " RAM:     [${R_BAR}] $RAM_P% (${RAM_U}MB / ${RAM_T}MB)"
echo -e " CPU:     [${C_BAR}] $CPU_V%"
echo -e " DISK:    [${D_BAR}] $DISK_P%"
echo -e " LIFE:    [${L_BAR}] $DAYS / 365 Days"
echo -e " HEALTH:  [${H_B}] $H_S"
echo -e " QUOTA:   [${BW_BAR}] ${BW_DATA} / ${DAILY_QUOTA} GB (Today)"
echo "----------------------------------------------------------------------------------"
echo -e " \033[1;31mSECURITY CARNAGE\033[0m"
echo "----------------------------------------------------------------------------------"
echo -e " BANS:    ${R}${TOTAL_DEF}${NC} Attacks | Recidive: ${Y}${RECIDIVE}${NC}"
echo -e " THREATS: ${R}${FAILED_SSH}${NC} Failed SSH attempts (24h)"
echo -e " TRAFFIC: ↓ ${B}${RX}${NC} KB/s | ↑ ${B}${TX}${NC} KB/s"
echo -e " NETWORK: Tailscale: ${B}${TS_IP}${NC}"
echo -e " ADGUARD:  ${AG_SQ} ${AG_D}"
echo -e " CADDY:    ${C_SQ} Online status"
echo -e " HEDGEDOC: ${H_SQ} Online status"
echo "----------------------------------------------------------------------------------"
