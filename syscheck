#!/bin/bash
IFS="|" read -r RAM_U RAM_T CPU DISK DAYS REBOOT RX TX BANS RECI SSH TS_IP AG_B AG_P AG_C C_C H_C < <(python3 ~/syscheck-project/syscheck-engine)

B='\033[1;34m'; Y='\033[1;33m'; R='\033[0;31m'; NC='\033[0m'
RAM_P=$(( RAM_U * 100 / RAM_T ))

get_bar() {
    local fill=$(( $1 / 7 )); [[ $fill -gt 15 ]] && fill=15
    local bar=""
    for ((i=0; i<fill; i++)); do bar+="█"; done
    for ((i=0; i<$((15-fill)); i++)); do bar+=" "; done
    echo -e "${B}${bar}${NC}"
}

fastfetch
echo "----------------------------------------------------------------"
echo -e " RAM:     [$(get_bar $RAM_P)] $RAM_P% ($RAM_U / $RAM_T MB)"
echo -e " CPU:     [$(get_bar $CPU)] $CPU%"
echo -e " DISK:    [$(get_bar $DISK)] $DISK%"
echo -e " LIFE:    [$(get_bar $(( DAYS > 0 ? (DAYS * 100 / 365 > 0 ? DAYS * 100 / 365 : 1) : 0 )))] $DAYS / 365 Days"
if [ "$REBOOT" == "1" ]; then
    echo -e " HEALTH:  [${R}███████████████${NC}] ${R}REBOOT NEEDED${NC}"
else
    echo -e " HEALTH:  [${B}███████████████${NC}] Healthy"
fi
echo "----------------------------------------------------------------"
echo -e " ${R}SECURITY CARNAGE${NC}"
echo "----------------------------------------------------------------"
echo -e " BANS:    ${R}${BANS}${NC} Attacks | Reci: ${Y}${RECI}${NC}"
echo -e " THREATS: ${R}${SSH}${NC} Failed SSH (24h)"
echo -e " TRAFFIC: ↓ ${B}${RX}${NC} KB/s | ↑ ${B}${TX}${NC} KB/s"
echo -e " NETWORK: Tailscale: ${B}${TS_IP}${NC}"

# Service status logic: Red square if status is not 200 (needs attention)
[ "$AG_C" == "200" ] && AS="${B}█${NC}" || AS="${R}█${NC}"
[ "$C_C" == "200" ] && CS="${B}█${NC}" || CS="${R}█${NC}"
[[ "$H_C" =~ (200|302) ]] && HS="${B}█${NC}" || HS="${R}█${NC}"

echo -e " ADGUARD:  $AS ${AG_B} blocks (${B}${AG_P}%${NC})"
echo -e " CADDY:    $CS Online status"
echo -e " HEDGEDOC: $HS Online status"
echo "----------------------------------------------------------------"
